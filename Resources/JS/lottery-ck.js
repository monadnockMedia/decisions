var Chart=function(e){self=this;this.dimen={bars:{width:1024,height:300},lines:{width:950,height:100},width:1024,height:500};this.padding={left:60,right:120,top:10,bottom:20,gutter:20};this.dimen.height=this.dimen.bars.height+this.dimen.lines.height+this.padding.gutter+self.padding.bottom+self.padding.top;this.dimen.width=this.dimen.bars.width;this.inner={bars:{top:self.dimen.lines.height+self.padding.gutter+self.padding.top,w:this.dimen.bars.width-this.padding.left-this.padding.right,h:this.dimen.bars.height-this.padding.top-this.padding.bottom,r:this.dimen.bars.width-this.padding.right,b:this.dimen.bars.height-this.padding.bottom},lines:{b:this.padding.top+this.dimen.lines.height}};this.params={lump:{value:5e5,allowance:11e3},annuity:75e4,term:20,rate:.04,max:5e4};this.sliderParams={rate:{min:.01,max:.1,step:.001,value:self.params.rate,slide:function(e,t){self.params.rate=t.value;$(t.handle).text((t.value*100).toFixed(2));self.redraw()}},allowance:{min:0,max:2e4,step:100,value:self.params.lump.allowance,slide:function(e,t){self.params.lump.allowance=t.value;$(t.handle).text(t.value.toFixed(2));self.redraw()}}};this.data=this.calculate();this.div=d3.select(e);this.svg=this.div.append("svg").attr("width",this.dimen.width).attr("height",this.dimen.height);this.scales={y:d3.scale.linear(),tall:d3.scale.linear(),x:d3.scale.ordinal(),x1:d3.scale.ordinal(),lineX:d3.scale.linear(),lineY:d3.scale.linear()};var t=d3.range(0,self.data.length);this.scales.y.range([this.inner.bars.b,this.padding.top]).domain([0,this.params.max]);this.scales.tall.range([0,this.inner.bars.h]).domain([0,this.params.max]);this.scales.x.rangeBands([this.padding.left,this.inner.bars.r],.33).domain(t);this.scales.lineX.range([this.padding.left,this.inner.bars.r]).domain([0,self.data.length]);this.scales.x1.rangeBands([0,self.scales.x.rangeBand()]).domain(["lump","annuity"]);this.scales.lineY.range([this.inner.lines.b,this.padding.top]).domain([0,1e6]);this.axes={y:d3.svg.axis().scale(this.scales.y).ticks(5)};this.axes.y.orient("left");this.axes.line=d3.svg.axis().scale(this.scales.lineY).ticks(3).tickFormat(function(e){return e/1e6+"m"});this.axes.line.orient("left");this.line=d3.svg.line().x(function(e,t){return self.scales.lineX(t)}).y(function(e){return self.scales.lineY(e)});this.buildAxes();this.buildBars();this.buildSlider();this.buildLines()};Chart.prototype.buildAxes=function(){this.yAxis=this.svg.append("g").attr("class","axis").attr("width",this.dimen.height).attr("height",30).append("g").attr("transform","translate("+self.padding.left+","+self.inner.bars.top+")").call(self.axes.y);this.svg.append("g").attr("class","axis").attr("width",this.dimen.height).attr("height",30).append("g").attr("transform","translate("+self.padding.left+","+self.padding.top+")").call(self.axes.line)};Chart.prototype.updateAxes=function(){var e=0,t=[0,Math.max(self.params.max,+self.data[0].lump.totalPaid)];console.log(t);self.scales.y.domain(t);self.scales.tall.domain(t);this.yAxis.call(self.axes.y)};Chart.prototype.buildBars=function(){this.barGroup=this.svg.append("g").attr({"class":"bars",transform:"translate(0,"+self.inner.bars.top+")"});this.barGroup.append("text").text("").attr({x:+self.inner.bars.r/4,y:20});this.barGroup.append("text").text("Year").attr({"class":"query",x:+self.inner.bars.r/2,y:self.inner.bars.b+30});this.pairs=this.barGroup.selectAll("g.pairs").data(self.data).enter().append("g").attr("class","pairs").attr("transform",function(e,t){return"translate("+self.scales.x(t)+",0)"});this.pairs.selectAll("rect").data(function(e){var t=[e.lump,e.annuity];return t}).enter().append("rect").attr("class",function(e){return e.key}).attr({x:function(e){return self.scales.x1(e.key)},height:function(e){return self.scales.tall(e.totalPaid)},width:self.scales.x1.rangeBand(),y:function(e){var t=self.scales.tall(e.totalPaid);return self.inner.bars.b-t}});this.pairs.append("text").attr({y:self.inner.bars.b+14}).text(function(e,t){return t+1});this.barGroup.append("line").attr({"class":"pipe",x1:self.padding.left,x2:self.inner.bars.r,y1:self.scales.y(self.data[0].annuity.totalPaid),y2:self.scales.y(self.data[0].annuity.totalPaid),"stroke-dasharray":"5, 5"});this.barGroup.append("text").attr({"class":"pipeLabel",y:self.scales.y(self.data[0].annuity.totalPaid)+5,x:self.inner.bars.r}).text("◁$"+self.data[0].annuity.totalPaid)};Chart.prototype.drawBars=function(){};Chart.prototype.buildLines=function(){this.lineGroup=this.svg.append("g").attr("class","linegroup").attr("transform","translate(0,"+self.padding.top+")");this.lineData={};this.lineGroup.append("text").text("").attr({"class":"query",x:+self.inner.bars.r/4,y:20});this.mapLines();this.lines=this.lineGroup.selectAll("path").data(Object.keys(this.lineData)).enter().append("path").attr("class",function(e){return e});this.lineLabels=this.lineGroup.selectAll("text.label").data(Object.keys(this.lineData)).enter().append("text").attr("class","label");this.drawLines()};Chart.prototype.mapLines=function(){this.lineData={annuity:this.data.map(function(e){return e.annuity.value}),lump:this.lineData=this.data.map(function(e){return e.lump.value})}};Chart.prototype.drawLines=function(){this.lines.attr("d",function(e){return self.line(self.lineData[e])});this.lineLabels.text(function(e){var t=self.lineData[e].length;return"◁$"+self.lineData[e][t-1]}).attr({x:self.inner.bars.r-22,y:function(e){var t=self.lineData[e].length;return self.scales.lineY(self.lineData[e][t-1])+5}})};Chart.prototype.redraw=function(){self.data=self.calculate();this.mapLines();this.updateAxes();this.pairs=this.barGroup.selectAll("g.pairs").data(self.data);this.pairs.selectAll("rect").data(function(e){var t=[e.lump,e.annuity];return t}).attr({x:function(e){return self.scales.x1(e.key)},height:function(e){return self.scales.tall(e.totalPaid)},width:self.scales.x1.rangeBand(),y:function(e){var t=self.scales.tall(e.totalPaid);return self.inner.bars.b-t}});this.barGroup.selectAll(".pipe").attr({x1:self.padding.left,x2:self.inner.bars.r,y1:self.scales.y(self.data[0].annuity.totalPaid),y2:self.scales.y(self.data[0].annuity.totalPaid),"stroke-dasharray":"5, 5"});this.barGroup.selectAll(".pipeLabel").attr({y:self.scales.y(self.data[0].annuity.totalPaid)+5,x:self.inner.bars.r}).text("◁$"+self.data[0].annuity.totalPaid);this.drawLines()};Chart.prototype.buildSlider=function(){this.div.append("h2").text("Interest Rate").attr("class","lump");this.div.append("div").attr("class","slider rate").attr({style:"width:"+self.inner.bars.w+"px; margin-left:"+self.padding.left+"px;"});$(".slider.rate").slider(self.sliderParams.rate);this.div.append("h2").text("Allowance").attr("class","lump");this.div.append("div").attr("class","slider allowance").attr({style:"width:"+self.inner.bars.w+"px; margin-left:"+self.padding.left+"px;"});$(".slider.allowance").slider(self.sliderParams.allowance)};Chart.prototype.calculate=function(){var e=this.params,t=[];for(i=0;i<e.term;i++){var n=i==0?e.lump.value:t[i-1].lump.value,r=i==0?e.annuity:t[i-1].annuity.value;o={};o.annuity={key:"annuity"};o.annuity.totalPaid=e.annuity/e.term;o.lump={};o.lump.key="lump";o.lump.fromInterest=n*e.rate;o.lump.fromAllowance=e.lump.allowance;o.lump.totalPaid=o.lump.fromInterest+o.lump.fromAllowance;o.annuity.value=r-o.annuity.totalPaid;o.lump.value=n-e.lump.allowance;t.push(o)}return t};