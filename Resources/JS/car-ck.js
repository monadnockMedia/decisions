function carGraph(e,t){self=this;this.months=["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"];this.data=null;this.axesPad=10;this.sliderP={rate:{min:1,max:21},contribution:{min:200,max:1e3}};this.cars={Economy:15e3,Midsized:25e3,Luxury:5e4};this.amParams={contrib:450,rate:20,balance:1e4};this.amortize();this.container=d3.select(e);this.w=this.stripPx(this.container.style("width"));this.h=this.stripPx(this.container.style("height"));this.padding={left:70,right:30,top:30,bottom:50};this.innerWidth=this.w-this.padding.left-this.padding.right;this.innerHeight=this.h-this.padding.top-this.padding.bottom;this.innerTop=this.h-this.padding.top;this.innerRight=this.w-this.padding.right;var n=5;this.setScales();this.setAxes();this.svg=this.container.append("svg").attr({width:this.w,height:this.h,"class":"lineGraph"});this.svg.append("defs").append("clipPath").attr("id","clip").append("svg:rect").attr({x:this.padding.left+n,y:0,width:this.innerWidth-n,height:this.innerHeight});this.chartBody=this.svg.append("g").attr("clip-path","url(#clip)").attr("class","chartBody");this.addAxes();this.addBars();this.addLines();this.addLegend();this.buildSliders()}cgP=carGraph.prototype;cgP.setScales=function(){this.scales={};this.scales.range={};this.scales.range.x=[this.padding.left,this.innerRight];this.scales.range.y=[this.h-this.padding.bottom,this.padding.top];this.scales.x=d3.time.scale().range(this.scales.range.x).domain(d3.extent(this.data,function(e){return+e.date}));this.scales.y=d3.scale.linear().range(this.scales.range.y).domain([0,this.cars.Luxury]);this.scales.iy=d3.scale.linear().range(this.scales.range.y).domain([0,self.amParams.contrib]);this.scales.box=d3.scale.ordinal().rangeRoundBands(this.scales.range.x,0).domain(d3.range(this.data.length))};cgP.updateScales=function(){this.scales.x.domain(d3.extent(this.data,function(e){return+e.date}));this.scales.y.domain([0,this.cars.Luxury])};cgP.setAxes=function(){this.xA=d3.svg.axis().scale(this.scales.x).orient("bottom").ticks(this.data.length).tickFormat(function(e){return e.getUTCFullYear()});this.yA=d3.svg.axis().scale(this.scales.y).orient("left").tickFormat(function(e){return finance.format(e,"USD")})};cgP.addAxes=function(){this.svg.append("g").attr({"class":"y axis lifted",transform:"translate("+(this.padding.left-this.axesPad)+","+0+")"}).call(this.yA)};cgP.updateAxes=function(){this.yA.scale(this.scales.y);this.svg.select(".y.axis").transition().call(this.yA);this.xA.scale(this.scales.x);this.svg.select(".x.axis").transition().call(this.xA)};cgP.amortize=function(){with(this.amParams){this.amParams.length=finance.calculateMonths(balance,rate,contrib);var amort=finance.calculateAmortization(balance,length,rate),dOff;amort.forEach(function(e,t){e.month=t;if(t==0){dOff=+e.date.getFullYear();e.year=0;e.cumToPrinciple=e.paymentToPrinciple}else{e.year=+e.date.getFullYear()-dOff;e.cumToPrinciple=amort[t-1].cumToPrinciple+e.paymentToPrinciple}e.totalPaid=e.cumToPrinciple+e.interest});this.data=amort}};cgP.addLines=function(){this.lineFunctions={interest:d3.svg.line().x(function(e){return self.scales.x(e.date)}).y(function(e){return self.scales.y(e.interest)}),balance:d3.svg.line().x(function(e){return self.scales.x(e.date)}).y(function(e){return self.scales.y(e.principle)}),total:d3.svg.line().x(function(e){return self.scales.x(e.date)}).y(function(e){return self.scales.y(e.totalPaid)}),area:d3.svg.line().x(function(e){return self.scales.x(e.date)}).y(function(e){return self.scales.y(e.val)})};this.lineGroup=this.svg.append("g").attr("class","lineGroup");this.area=this.lineGroup.append("path").attr("class","line area");this.total=this.lineGroup.append("path").attr("class","line total");this.interest=this.lineGroup.append("path").attr("class","line interest");this.balance=this.lineGroup.append("path").attr("class","line balance lifted");this.lineLabel=this.lineGroup.append("g").attr("class","lifted");this.lineNode=this.lineLabel.append("circle").attr({"class":"balance"});this.lineText=this.lineLabel.append("text").attr({"class":"linelabel "}).text("Balance");this.drawLines()};cgP.drawLines=function(){var e=this.data.map(function(e){return{date:e.date,val:e.cumToPrinciple}}),t=this.data.map(function(e){return{date:e.date,val:e.totalPaid}});areaData=e.concat(t.reverse());this.area.datum(areaData).transition().duration(150).style("opacity",0).attr("d",self.lineFunctions.area).transition().duration(1500).style("opacity",1);this.total.datum(this.data).transition().delay(170).attr("d",self.lineFunctions.total);this.balance.datum(this.data).transition().attr("d",this.lineFunctions.balance);this.lineNode.attr({r:6,cx:self.scales.box(0),cy:self.scales.y(self.data[0].principle)});this.lineText.attr({transform:"translate("+(self.scales.box(0)+12)+","+(self.scales.y(self.data[0].principle)-8)+") rotate(-45)"})};cgP.addBars=function(){this.barGroup=this.svg.append("g").attr("class","barGroup");boxWidth=6;this.bar=this.barGroup.selectAll("g").data(this.data).enter().append("g").attr("class","bar").attr("transform",function(e,t){return"translate("+self.scales.box(t)+",0)"});lines=!1;bars=!0;if(!lines&&bars){this.bar.append("rect").attr({y:function(e){return self.scales.iy(e.paymentToPrinciple)},height:function(e){return self.h-self.padding.bottom-self.scales.iy(e.paymentToPrinciple)},width:this.scales.box.rangeBand()-4,"class":"principle"});this.bar.append("rect").attr({y:function(e){return self.scales.iy(e.payment)},height:function(e){return self.h-self.padding.bottom-self.scales.iy(e.paymentToInterest)-1},width:this.scales.box.rangeBand()-4,"class":"interest"})}if(!lines&&!bars){this.bar.append("rect").attr({x:function(e,t){return self.scales.box(t)},y:function(e){return self.scales.y(e.cumToPrinciple)},height:function(e){return self.h-self.padding.bottom-self.scales.y(e.cumToPrinciple)},width:this.scales.box.rangeBand()-4,"class":"principle"});this.bar.append("rect").attr({x:function(e,t){return self.scales.box(t)},y:function(e){return self.scales.y(e.totalPaid)},height:function(e){return self.h-self.padding.bottom-self.scales.y(e.interest)-1},width:this.scales.box.rangeBand()-4,"class":"interest"})}this.bar.append("text").attr({x:self.scales.box.rangeBand()/2,y:self.h-self.padding.bottom+18,"text-anchor":"middle","class":"year"}).text(function(e,t){var n=null;if(+e.date.getMonth()%12==0||t==0)n=e.date.getFullYear();return n});this.bar.append("text").attr({transform:"translate(4,"+(self.h-self.padding.bottom-15)+") rotate(90)","text-anchor":"middle","class":"month"}).text(function(e){ret=self.months[+e.date.getMonth()];return ret});if(lines){this.pLine=this.bar.append("line").attr("class","principle").attr({x1:0,y1:self.h-self.padding.bottom,x2:0,y2:function(e){return self.scales.iy(e.paymentToPrinciple)}});this.iLine=this.bar.append("line").attr({x1:0,y1:function(e){return self.scales.iy(e.paymentToPrinciple)},x2:0,y2:function(e){return self.scales.iy(e.payment)},fill:"#f00","class":"interest"})}};cgP.addLegend=function(){this.legend=this.container.append("div").attr("id","legend");this.legend.append("div").attr("class","key payment interest");this.legend.append("p").text("Payment to Interest");this.legend.append("div").attr("class","key principle interest");this.legend.append("p").text("Payment to Principle")};cgP.buildSliders=function(){this.buttonParams=[{name:"Economy",price:15e3,icon:"blank.svg"},{name:"Midsized",price:25e3,icon:"blank.svg"},{name:"Luxury",price:5e4,icon:"blank.svg"}];this.container.append("div").attr({"class":"tooltip"}).append("h1");this.container.append("div").attr({"class":"buttons",title:"Car Type"}).selectAll("div").data(this.buttonParams).enter().append("div").attr({"class":function(e){return"carButton "+e.name},type:function(e){return e.name}}).html(function(e){return e.name});$(".carButton").button().click(function(e){var t=$(this).attr("type");console.log(t);$(".carButton").each(function(){check=$(this).attr("type")==t;$(this).toggleClass("car-selected",check)});self.amParams.balance=self.cars[t];console.log(self.amParams);self.redraw()});this.contributionSlider=this.container.append("div").attr({"class":"slider contribution car",title:"Payment"});this.rateSlider=this.container.append("div").attr({"class":"slider rate car",title:"Loan APR"});$(".slider").css({"margin-left":this.padding.left*2,"margin-right":this.padding.right});$(".buttons").css({"margin-left":this.padding.left*2,"margin-right":this.padding.right});var e=function(e){},t=function(){$(".tooltip").animate({opacity:0})},n=function(){$(".tooltip").animate({opacity:1})};$(".slider.contribution").slider({min:self.sliderP.contribution.min,max:self.sliderP.contribution.max,value:self.amParams.contrib,slide:function(e,t){console.log(t.handle);$(".tooltip").css({left:self.sliderScales.contribution(t.value),top:$(t.handle).offset().top}).html("$"+t.value)},stop:function(e,n){$(this).find(".ui-slider-handle").text("$"+n.value);t();self.redraw();self.amParams.contrib=n.value}}).find("a").html("$"+self.amParams.contrib);this.sliderScales={};contOff=$(".slider.contribution").offset();contW=$(".slider.contribution").width();this.sliderScales.contribution=d3.scale.linear().range([contOff.left,contOff.left+contW]).domain([self.sliderP.contribution.min,self.sliderP.contribution.max]);$(".slider.rate").slider({min:self.sliderP.rate.min,max:self.sliderP.rate.max,step:1,value:self.amParams.rate,slide:function(e,t){console.log("rateChange");$(".tooltip").css({left:self.sliderScales.rate(t.value),top:$(t.handle).offset().top}).html(t.value+"%");self.amParams.rate=t.value},stop:function(e,n){$(this).find(".ui-slider-handle").text(n.value+"%");t();console.log(self.amParams);self.redraw()}}).find("a").html(self.amParams.rate+"%");rateOff=$(".slider.rate").offset();rateW=$(".slider.rate").width();this.sliderScales.rate=d3.scale.linear().range([rateOff.left,rateOff.left+rateW]).domain([self.sliderP.rate.min,self.sliderP.rate.max]);$(".slider").slider({start:function(e,t){n()}})};cgP.redraw=function(){this.amortize();this.updateScales();this.updateAxes();this.drawLines()};cgP.stripPx=function(e){i=e.indexOf("px");return+e.slice(0,i)};