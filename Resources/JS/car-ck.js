function carGraph(e,t){self=this;this.months=["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"];this.data=null;this.axesPad=10;this.sliderP={rate:{min:1,max:21},contribution:{min:200,max:1e3}};this.cars={Economy:15e3,Midsized:25e3,Luxury:5e4};this.amParams={contrib:1200,rate:20,balance:25e3};this.amortize();this.container=d3.select(e);this.w=this.stripPx(this.container.style("width"));this.h=this.stripPx(this.container.style("height"));this.padding={left:68,right:80,top:30,bottom:60,font:4};this.innerWidth=this.w-this.padding.left-this.padding.right;this.innerHeight=this.h-this.padding.top-this.padding.bottom;this.innerTop=this.h-this.padding.top;this.innerRight=this.w-this.padding.right;var n=25;this.lineGroupH=(this.h-this.padding.bottom)*.8;this.barGroupH=this.h*.2;this.barGroupY=this.lineGroupH+n;var r=5;this.setScales();this.setAxes();this.svg=this.container.append("svg").attr({width:this.w,height:this.h,"class":"lineGraph"});this.lineGroup=this.svg.append("g").attr("class","lineGroup");this.svg.append("defs").append("clipPath").attr("id","clip").append("svg:rect").attr({x:this.padding.left+r,y:0,width:this.innerWidth-r,height:this.innerHeight});this.chartBody=this.lineGroup.append("g").attr("clip-path","url(#clip)").attr("class","chartBody");this.addBars();this.addAxes();this.addLines();this.addLegend();this.buildSliders()}cgP=carGraph.prototype;cgP.setScales=function(){this.scales={};this.scales.range={};this.scales.range.x=[this.padding.left,this.innerRight];this.scales.range.y=[this.lineGroupH,this.padding.top];this.scales.range.boxy=[this.barGroupH,0];this.scales.x=d3.time.scale().range(this.scales.range.x).domain(d3.extent(this.data,function(e){return+e.date}));this.scales.y=d3.scale.linear().range(this.scales.range.y).domain([0,d3.max(this.data,function(e){return+e.totalPaid})]);this.scales.iy=d3.scale.linear().range(this.scales.range.boxy).domain([0,self.amParams.contrib]);this.scales.box=d3.scale.ordinal().rangeBands(this.scales.range.x).domain(d3.range(this.data.length))};cgP.updateScales=function(){this.scales.x.domain(d3.extent(this.data,function(e){return+e.date}));this.scales.y.domain([0,this.cars.Luxury])};cgP.setAxes=function(){this.xA=d3.svg.axis().scale(this.scales.x).orient("bottom").ticks(this.data.length).tickFormat(function(e){return e.getUTCFullYear()});this.yA=d3.svg.axis().scale(this.scales.y).orient("left").tickFormat(function(e){return finance.format(e,"USD")});this.bA=d3.svg.axis().scale(this.scales.iy).orient("left").tickValues([0,this.amParams.contrib]).tickFormat(function(e){return finance.format(e,"USD")})};cgP.addAxes=function(){this.barGroup.append("g").attr({"class":"y axis lifted",transform:"translate("+(this.padding.left-this.axesPad)+","+0+")"}).call(this.bA);this.lineGroup.append("g").attr({"class":"y axis lifted",transform:"translate("+(this.padding.left-this.axesPad)+","+0+")"}).call(this.yA)};cgP.updateAxes=function(){this.yA.scale(this.scales.y);this.lineGroup.select(".y.axis").transition().call(this.yA);this.xA.scale(this.scales.x);this.lineGroup.select(".x.axis").transition().call(this.xA)};cgP.amortize=function(){with(this.amParams){this.amParams.length=finance.calculateMonths(balance,rate,contrib);var amort=finance.calculateAmortization(balance,length,rate),dOff;amort.forEach(function(e,t){e.month=t;if(t==0){dOff=+e.date.getFullYear();e.year=0;e.cumToPrinciple=e.paymentToPrinciple}else{e.year=+e.date.getFullYear()-dOff;e.cumToPrinciple=amort[t-1].cumToPrinciple+e.paymentToPrinciple}e.totalPaid=e.cumToPrinciple+e.interest});this.data=amort}};cgP.addLines=function(){this.lineFunctions={interest:d3.svg.line().x(function(e){return self.scales.x(e.date)}).y(function(e){return self.scales.y(e.interest)}),balance:d3.svg.line().x(function(e){return self.scales.x(e.date)}).y(function(e){return self.scales.y(e.principle)}),total:d3.svg.line().x(function(e){return self.scales.x(e.date)}).y(function(e){return self.scales.y(e.totalPaid)}),area:d3.svg.line().x(function(e){return self.scales.x(e.date)}).y(function(e){return self.scales.y(e.val)}),principle:d3.svg.line().x(function(e){return self.scales.x(e.date)}).y(function(e){return self.scales.y(e.val)})};this.area=this.lineGroup.append("path").attr("class","line area").attr("id","interestArea");this.total=this.lineGroup.append("path").attr("class","line total lifted").attr("id","lineTotal");this.balance=this.lineGroup.append("path").attr("class","line balance lifted").attr("id","lineBalance");this.lineLabel=this.lineGroup.append("g").attr("class","outline");this.mid=this.lineGroup.append("path").attr("id","toPrinciple");this.lineNodeTotal=this.lineLabel.append("circle").attr({"class":"total"});this.lineNodeBalance=this.lineLabel.append("circle").attr({"class":"balance"});this.nodeLabelTotal=this.lineLabel.append("text").attr("class","linelabel ");this.nodeLabelInterest=this.lineLabel.append("text").attr("class","linelabel ");this.nodeLineInterest=this.lineLabel.append("line").attr("class","linelabel outlinesm");this.lineTextBalance=this.lineLabel.append("text").attr({"class":"linelabel balance",dy:-5}).append("textPath").text("Balance").attr("startOffset","5%");this.lineTextTotal=this.lineLabel.append("text").attr({"class":"linelabel total",dy:-5}).append("textPath").text("Total Paid").attr("startOffset","70%");this.lineTextInterest=this.lineGroup.append("text").attr({"class":"linelabel outline interestPaid",dy:5}).append("textPath").text("Interest Paid").attr("startOffset","70%");this.drawLines()};cgP.drawLines=function(){var e=this.data.map(function(e){return{date:e.date,val:e.cumToPrinciple}}),t=this.data.map(function(e){return{date:e.date,val:e.totalPaid}}),n=this.data.map(function(e){return{date:e.date,val:e.totalPaid-(e.totalPaid-e.cumToPrinciple)/2}});areaData=e.concat(t.reverse());this.area.datum(areaData).transition().duration(150).style("opacity",0).attr("d",self.lineFunctions.area).transition().duration(1500).style("opacity",1);this.total.datum(this.data).transition().delay(170).attr("d",self.lineFunctions.total);this.balance.datum(this.data).transition().attr("d",this.lineFunctions.balance);this.mid.datum(n).attr("d",this.lineFunctions.principle);nodeRad=6;this.nodeLineInterest.attr({x1:self.innerRight,y1:this.scales.y(e[e.length-1].val),x2:self.innerRight,y2:this.scales.y(t[e.length-1].val)});this.lineNodeTotal.attr({r:nodeRad,cx:self.scales.box(self.data.length-1)+self.scales.box.rangeBand(),cy:self.scales.y(self.data[self.data.length-1].totalPaid)});this.nodeLabelTotal.attr({x:self.innerRight+self.padding.font-nodeRad/2,y:self.scales.y(self.data[self.data.length-1].totalPaid)+nodeRad/2}).text("◂"+finance.format(self.data[self.data.length-1].totalPaid.toFixed(0),"USD"));this.nodeLabelInterest.attr({x:self.innerRight+self.padding.font-nodeRad/2,y:self.scales.y(n[n.length-1].val)+nodeRad/2}).text("◂"+finance.format(n[n.length-1].val.toFixed(0),"USD"));this.lineNodeBalance.attr({r:6,cx:self.scales.box(0),cy:self.scales.y(self.data[0].principle)});this.lineTextBalance.attr({});this.lineTextBalance.attr({"xlink:href":"#lineBalance"});this.lineTextTotal.attr({"xlink:href":"#lineTotal"});this.lineTextInterest.attr({"xlink:href":"#toPrinciple"})};cgP.addBars=function(){this.barGroup=this.svg.append("g").attr("class","barGroup").attr("transform","translate(0,"+(self.barGroupY+12)+")");this.yearGroup=this.svg.append("g").attr("class","yearGroup").attr("transform","translate(0,"+(self.barGroupY-18)+")");boxWidth=6;this.bar=this.barGroup.selectAll("g").data(this.data).enter().append("g").attr("class","bar").attr("transform",function(e,t){return"translate("+self.scales.box(t)+","+0+")"});bars=!0;this.bar.append("rect").attr({x:2,y:0,height:function(e){return self.barGroupH-self.scales.iy(e.paymentToInterest)},width:this.scales.box.rangeBand()-4,"class":"interest"});this.bar.append("rect").attr({x:2,y:function(e){return self.barGroupH-self.scales.iy(e.paymentToInterest)},height:function(e){return self.barGroupH-self.scales.iy(e.paymentToPrinciple)},width:this.scales.box.rangeBand()-4,"class":"principle"});this.bar.append("text").attr({transform:"translate("+self.scales.box.rangeBand()/2+","+14+") rotate(-90)","text-anchor":"middle","class":"month outlinesm"}).text(function(e){ret=self.months[+e.date.getMonth()];return ret});this.yearRanges=[];var e=-1,t=-1;$.each(this.data,function(n,r){if(+r.year!=e){e=r.year;var i={};i.min=n;i.date=r.date;self.yearRanges.push(i);t=n}});this.yearRanges=this.yearRanges.map(function(e,t){I=t==self.yearRanges.length-1?self.data.length:self.yearRanges[t+1].min;var n=e;n.max=I;console.log("index");console.log(e);return n});this.years=this.yearGroup.selectAll("g").data(this.yearRanges).enter().append("g").attr({transform:function(e){return"translate("+self.scales.box(e.min)+",0)"}});this.years.append("rect").attr({x:0,y:0,width:function(e){return self.scales.box.rangeBand()*(e.max-e.min)-2},height:20,"class":"yearBar","stroke-dasharray":"2,1"});this.years.append("text").text(function(e){return e.date.getFullYear()}).attr({"class":"year outlinesm",y:20-self.padding.font,x:self.padding.font})};cgP.addLegend=function(){};cgP.buildSliders=function(){this.buttonParams=[{name:"Economy",price:15e3,icon:"blank.svg"},{name:"Midsized",price:25e3,icon:"blank.svg"},{name:"Luxury",price:5e4,icon:"blank.svg"}];this.container.append("div").attr({"class":"tooltip"}).append("h1");this.container.append("div").attr({"class":"buttons",title:"Car Type"}).selectAll("div").data(this.buttonParams).enter().append("div").attr({"class":function(e){return"carButton "+e.name},type:function(e){return e.name}}).html(function(e){return e.name});$(".carButton").button().click(function(e){var t=$(this).attr("type");console.log(t);$(".carButton").each(function(){check=$(this).attr("type")==t;$(this).toggleClass("car-selected",check)});self.amParams.balance=self.cars[t];console.log(self.amParams);self.redraw()});this.contributionSlider=this.container.append("div").attr({"class":"slider contribution car",title:"Payment"});this.rateSlider=this.container.append("div").attr({"class":"slider rate car",title:"Loan APR"});$(".slider").css({"margin-left":this.padding.left*2,"margin-right":this.padding.right});$(".buttons").css({"margin-left":this.padding.left*2,"margin-right":this.padding.right});var e=function(e){},t=function(){$(".tooltip").animate({opacity:0})},n=function(){$(".tooltip").animate({opacity:1})};$(".slider.contribution").slider({min:self.sliderP.contribution.min,max:self.sliderP.contribution.max,value:self.amParams.contrib,slide:function(e,t){console.log(t.handle);$(".tooltip").css({left:self.sliderScales.contribution(t.value),top:$(t.handle).offset().top}).html("$"+t.value)},stop:function(e,n){$(this).find(".ui-slider-handle").text("$"+n.value);t();self.redraw();self.amParams.contrib=n.value}}).find("a").html("$"+self.amParams.contrib);this.sliderScales={};contOff=$(".slider.contribution").offset();contW=$(".slider.contribution").width();this.sliderScales.contribution=d3.scale.linear().range([contOff.left,contOff.left+contW]).domain([self.sliderP.contribution.min,self.sliderP.contribution.max]);$(".slider.rate").slider({min:self.sliderP.rate.min,max:self.sliderP.rate.max,step:1,value:self.amParams.rate,slide:function(e,t){console.log("rateChange");$(".tooltip").css({left:self.sliderScales.rate(t.value),top:$(t.handle).offset().top}).html(t.value+"%");self.amParams.rate=t.value},stop:function(e,n){$(this).find(".ui-slider-handle").text(n.value+"%");t();console.log(self.amParams);self.redraw()}}).find("a").html(self.amParams.rate+"%");rateOff=$(".slider.rate").offset();rateW=$(".slider.rate").width();this.sliderScales.rate=d3.scale.linear().range([rateOff.left,rateOff.left+rateW]).domain([self.sliderP.rate.min,self.sliderP.rate.max]);$(".slider").slider({start:function(e,t){n()}});rectSize=12;legendPad=6;txtLeft=rectSize+this.padding.font;rectLeft=0;this.smLegend=this.barGroup.append("g").attr({"class":"legend",transform:"translate("+(this.innerRight+legendPad)+","+legendPad+")"});this.iL=this.smLegend.append("g");this.iL.append("rect").attr({x:rectLeft,width:rectSize,height:rectSize,"class":"interest"});this.iL.append("text").attr({y:rectSize-2,x:txtLeft,"class":"legendText"}).text("Interest");this.pL=this.smLegend.append("g").attr("transform","translate(0,"+(rectSize+legendPad)+")");this.pL.append("rect").attr({x:rectLeft,width:rectSize,height:rectSize,"class":"principle"});this.pL.append("text").attr({y:rectSize-2,x:txtLeft,"class":"legendText"}).text("Principle")};cgP.redraw=function(){this.amortize();this.updateScales();this.updateAxes();this.drawLines()};cgP.stripPx=function(e){i=e.indexOf("px");return+e.slice(0,i)};